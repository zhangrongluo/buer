#### 缺口系统说明文档
##### 缺口定义
- **DownGap:向下跳空缺口**，当某个交易日的最高价低于上一交易日的最低价，这两个交易日的K线图即构成向下跳空缺口。该日即是该缺口的**交易基准日 trade_date**，该日的上一日的最低价即为该缺口的 **target_price 目标价**。在 trade_date 日之后，市场价格高于 target_price，该缺口即回补（fill），该日期为缺口的回补日期 fill_date。
- **UpGap:向上跳空缺口**，当某个交易日的最低价高一上一交易日的最高价，这两个交易日的K线图即构成向上跳空缺口。
- **Downgap向下缺口回补就是市场价格上涨直到超过 target_price 的过程**。缺口系统通过对向下跳空缺口建模、训练、推理,寻找向下缺口回补上涨过程中特定的交易机会。**根据缺口系统的统计,向下缺口回补的比例超过 96%**。
#### DownGap 数据集的创建、训练和推理
- 每个交易日收盘后，缺口系统下载全部股票的当日交易数据，根据交易数据，缺口系统搜索计算全部股票当日新增的缺口（向上缺口和向下缺口），按照股票名称代码分别保存在对应股票缺口数据集中（csv 文件），保存目录为 **dataset** 目录。
- 同时缺口系统对每个股票缺口数据集中还未回补的缺口进行计算检测。如果已经回补，则在该股票缺口数据集中记录该缺口的回补日期、回补天数和回补期间收益率$$（target\_price-回补期间最低价格)/回补期间最低价格。$$
- 其次缺口系统将全部股票的缺口数据集合并，剔除向上缺口UpGap，只保留向下缺口DownGap，保存在 **temp** 目录下。
- 系统对全部股票DownGap 数据集划分为**训练集、验证集、测试集和交易集**，训练集、验证集和测试集为已回补的缺口数据集，交易集为**指定天数TRADE_COVERAGE_DAYS**范围内所有未回补的向下缺口。缺口系统使用已训练好的模型对测试集和交易集进行预测，结果保存在 **predict** 目录下。预测后的测试集包含每个缺口预测收益率和实际收益率及其差异，预测后交易集仅包含模型预测的收益率。
- 对预测后的交易集，进行筛选（剔除预测收益率低于特定值的数据），生成交易清单，保存在 **trade** 目录下。
- 系统定期（一般以周为单位）对全部向下跳空缺口数据集进行训练，生成新的模型，和老模型合并后排序，保留训练指标最好的 12 个模型用于推理和预测，保存在 **models** 目录下。

#### 缺口系统运行模式说明：
- 缺口系统有两种运行模式：分步模型和自动模型
- **分步模式**脚本为 jupyter notebook 文本: datasets.ipynb、models_downgap.ipynb、predict_downgap.ipynb 和 trade_downgap.ipynb，按顺序执行上述文件，可以分步观察缺口模型下不同参数下投资组合数据集建立、模型训练、测试集和交易集的推理、创建买入清单等过程。该模式主要用于错误调试和模型效果观察，无法执行交易模块。
- **自动模式**脚本为 auto_jobs_downgap.py,执行该文件即可按照预定的流程，每日自动下载交易数据、指标数据、交易日历、涨跌停清单、停牌清单、分红派息记录、除权参数等、合并预测数据集、创建买入清单、交易前除权、实际交易等环节。

#### 参数说明:
##### DownGap模型由以下参数来控制：
- MAX_TRADE_DAYS：最大交易天数，它和缺口回补天数是同一个数据。在股票进入了holding_list.csv后，该参数决定了股票最大的持有交易天数（等于MAX_TRADE_DAYS-缺口已经持续的日期）。该参数是以交易日历天数（非自然日历天数）来计算的。在确定训练集的时候，该参数是一个筛选因素，只有缺口回补天数小于等于该参数的数据，才会选入训练数据集。
- TRADE_COVERAGE_DAYS：从今日向前计算的交易天数。一个缺口生成后，它在trade_pred.csv和buy_in_list.csv文件中流转的最大天数。在确定交易集的时候，该参数是一个筛选因素，即缺口基准日 trade_date 距离今日的交易天数小于等于该参数，才会选入交易集。一旦超过该日期后，缺口系统不再将该缺口列入trade_pred.csv和buy_in_list.csv，不再跟踪该缺口。和MAX_TRADE_DAYS一样，该参数是以交易日历天数（非自然日历天数）来计算的。
- TEST_DATASET_PERCENT：测试数据集占训练数据集的比重。
- MIN_PRED_RATE：最低预期收益率，在确定buy_in_list.csv清单时，该参数是一个筛选因素。只用当trade_pred.csv文件中缺口预期收益率大于该参数时，才能入选buy_in_list.csv文件。
- PRED_RATE_PCT：预期收益率折扣百分比，决定缺口是否可以买入的先决条件:市场价和缺口 target_price之间的价格收益水平大于该缺口预期收益率和该参数的乘积。
- COST_FEE：交易税费合计，设定为万分之6，申万宏源证券的实际交易水平为万分之3.5。
- MAX_STOCKS：最大持股数，当持股数超过此参数值时，系统不再买入新的股票。
- ONE_TIME_FUNDS：单次买入投入的资金额度。
- MIN_STOCK_PRICE：买入股票的最低价格，低于此价格的股票，系统不会买入。
- SHUFFLE：决定训练时是否打乱数据集。
- PRED_MODELS：用于预测交易集预期收益率的模型数。
- initial_funds：初始投入资金。
- additional_rate：当第一跌停缺口出现后，通过预期收益率推断会继续出现跌停或者大跌，从而可能出现第二个大缺口时，提高第一个缺口的收益率水平，阻止交易。
- PAUSE：采用TS模式获取实时价格的情况下，获取价格后的时间间隔。
- exception_list：排除列表，股票名称中含有列表中的文字，不会列入买入清单。
#### 难点问题：连续缺口的买点如何确定
##### 多个小缺口同时存在
- 如果存在多个缺口未买入，每个缺口买点确定的方式和单独缺口买点的确定方式不同。将全部缺口买点的最低值作为全部缺口的买点。一旦达到买点，则全部缺口一起买入。这样处理比较符合常识，从风险控制的角度来说，也是最稳妥的。
- 如果buy_in_list.csv出现三个以上未买入的缺口，缺口系统采用了回避的做法，不会买入这个股票。
##### 跌停，**特别是连续跌停**形成的缺口，隐含了较大的风险，需要谨慎对待
- 在buy_in_list.csv中，当一个缺口当天接近跌停（判断标准为pct_chg绝对值大于涨停幅度的 95%, 如果涨停幅度为 10%，那么今日下跌幅度超过 9.5%），同时缺口系统推算该缺口会继续接近跌停（判断标准为缺口当日的预测收益率pred，如果 $$pred > 1/(1-limit*0.95)^2-1, limit为涨停幅度）$$ 即意味着系统推算该股票还会再来一个跌停。
- 在实际运行中，上述情形通常是以再一个跌停板的形式来打开买入空间。同时第二个跌停板也会形成一个新的买入缺口。这时buy_in_list.csv中会同时存在同一个股票的2个（或者更多）买入缺口，该如何确定第一个缺口的买入价格呢？
- 缺口系统中采用了additional_rate参数，通过增加预期收益率的方式降低买点，来提供额外的安全保证。
#### 风险来源
##### 缺口系统的交易风险可能来自于方方面面
- 模型失效。模型在训练集和测试集上较好拟合，在交易集上拟合无效。
- 数据集风险。训练集、验证集、测试集和交易集采用了不同的选择标准，比如交易集使用了排除列表筛选，而训练集、测试集未使用排除列表筛选。
- 执行风险。即在模型发出买入卖出信号后，实际操作和模型存在差异。
- 股票实时价格获取速度。如果股票实时价格获取速度太慢，可能会丧失交易机会。
- 研究不够深入，未能发现缺口行为模式的变化。比如缺口回补的比例出现了显著的降低，但是未能及时反映在模型中，导致模型预测功能降低甚至失效。
- 代码错误。这种风险无处不在，防不胜防。如前次把time.sleep()写成了time.slee(),由于在线程池中运行，没有报错，导致卖出模块失效，原因难寻。比如yyyymmdd型日期格式的处理，在保存过程中会出现string向float的自主转换，这些小问题，如果关注不到，也会造成大麻烦。今后处理日期型字段，将采用yyyymmdd H:m:s格式。比如np.nan、None的区别，也会造成不少问题。
- 缺口系统没有对指标统一数据格式，比如对于涨跌幅数据，有些文件以0.05 表示 5%，有些文件以 5 表示 5%，务必要注意这个问题。
#### 风险控制
##### DownGap 模型采用以下风险控制措施
- 通过最大持股个数MAX_STOCKS来控制单个股票最大投资比例。该参数一般要超过50，从而控制单个股票最大持仓比例不超过2%。
- 通过单次买入资金ONE_TIME_FUNDS来控制单次买入的金额。
- 通过最大持股个数MAX_STOCKS 和 单次买入资金ONE_TIME_FUNDS来控制最大投资金额占可投资金额的比例。
- 通过exception_list强制排除风险股票:退市股票、st股票、pt股票等。
- 通过最低买入价格MIN_STOCK_PRICE来回避股价过低的股票。
- 通过calculate_gaps_buy_in_points函数，调整连续多缺口，特别是连续跌停多缺口的买点调整来控制连续跌停风险。
- 如果缺口预期收益率pred超过MIN_PRED_RATE 30%，则买入资金在ONE_TIME_FUNDS基础上提高15%，实现风控和收益的平衡。
- 买入时，跌停不买，处于下跌过程不买。
- 卖出时，涨停不卖，处于上涨过程不卖。
- 参数设置问题：
  - MIN_PRED_RATE和PRED_RATE_PCT参数的取值直接影响投资风险和效果。MIN_PRED_RATE越低，进入buy_in_list.csv缺口数量就越多。MIN_PRED_RATE * PRED_RATE_PCT越低，就越容易成交（成交价格较高即可成交），成交笔数较多，但是投资风险较大；MIN_PRED_RATE * PRED_RATE_PCT越高，成交就越困难（成交价格较低才可成交），投资笔数较少，但是投资风险较小。还需要持续测试优化，在投资笔数 * 投资收益优化上取得较好的结果。
  - TRADE_COVERAGE_DAYS是系统跟踪一个缺口的天数，最好和MAX_TRADE_DAYS保持15-20天的差距。
#### 几个文件中的指标说明
##### 缺口数据集文件
- trade_date：缺口形成的基准日。
- fill_date：缺口回补的日期。
- days：今日和缺口基准日之间的间隔天数，以交易日历为基础计算。
- gap_percent：缺口比率，等于（缺口基准日最高价-基准日前一日最低价）/基准日前一日最低价。
- pct_chg：缺口基准日当日涨跌幅。
- vol_ratio：量比，即今日成交量/昨日成交量。 
- RSI和K指标：即是股票技术分析中的RSI指标和K指标。K指标默认天数为9天。
- turnover_rate：换手率。
- rise_percent：缺口回补过程中的实际涨幅，等于（缺口基准日前一日最低价-回补过程中的最低价）/回补过程中的最低价。缺口基准日前一日最低价即target_price。这个值就是数据集的标签值。
##### buy_in_list.csv
- trade_date：缺口形成的基准日。
- fill_date： 缺口回补日期，为空。
- days：今天和缺口基准日之间的间隔天数，以交易日历为基础计算。
- gap_percent：缺口比率，等于（缺口基准日最高价-基准日前一日最低价）/基准日前一日最低价。
- pct_chg：缺口基准日当日涨跌幅。
- pred：模型预测的缺口收益率，即rise_percent的预测值。
- real: 缺口实际收益率，为空。
- target_price：缺口买入后的上涨的目标价格，等于缺口基准日前一日最低价。
##### holding_list.csv
- days：今天和缺口基准日之间的间隔天数，以交易日历为基础计算。
- holding_days：持有天数，等于今天和买入日期之间的间隔天数，以自然日历为基础计算。
- target_price：缺口买入后的卖出的目标价格，等于缺口基准日前一日最低价。
- date_in和date_out：买入日期和卖出日期。
- price_in、price_out和price_now：买入价 卖出价和现价。
- amount：股票数量。
- cost_fee：交易税费比例，设定值为万分之6。
- profit：利润额，等于(price_now*(1-cost_fee) - price_in*(1+cost_fee)) * amount
- rate_pred和rate_pct：即缺口买入时，系统设定的MIN_PRED_RATE和PRED_RATE_PCT值。
- rate_current：现在的收益率，等于profit / (price_in * amount)
- rate_yearly：年化收益率，等于rate_current * 365 / holding_days，以自然日历天数计算。
