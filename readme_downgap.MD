#### 注意事项
##### 每日需要定期更新数据，以获取最新的Gap缺口数据集：
- 更新TRADE_RECORD_PATH目录下的全部股票交易记录，里面保存了沪深300行业中股票的每日的财务指标信息。更新后需要调用get_trade_date_equal_today_nums接口检查数据更新情况。
- 更新dailydata_root目录下全部文件数据，里面保存了沪深300行业中股票每日的交易价格信息，含open、high、low、close、pre_close、chg_pct、vol等，交易信息更新后需要调用get_daily_data_equal_today_nums接口检查数据更新情况。
- 调用get_gaps_statistic_data 计算获取最新的缺口数据集，刷新重置数据集，合并成为最新的Gap数据集all_gap_data.csv文件。
- 有时会缺少财务记录文件，从而导致合并数据集报错。需要到quant-stock项目下data.py或者dataset项目下Roe_data.ipynb中运行check_stockcodes_integrity检查记录完整性。
- Downgap有两个分支，一个指标中带有k值，一个指标中没有k值。当从一个分支转到另一个分支的时候，需要重新计算生成缺口数据集all_gap_data.csv文件。
#### 参数说明:
##### DownGap模型由以下参数来控制：
- MAX_TRADE_DAYS：最大交易天数，它和缺口回补天数是同一个数据。在股票进入了holding_list.csv后，该参数决定了股票最大的持有天数（等于MAX_TRADE_DAYS-缺口已经持续的日期）。该参数是以交易日历天数（非自然日历天数）来计算的。在确定训练集的时候，该参数是一个筛选因素，只有缺口回补天数小于等于该参数的数据，才会选入训练数据集。
- TRADE_COVERAGE_DAYS：交易向前覆盖天数。一个缺口生成后，它在trade_pred.csv和buy_in_list.csv文件中流转的最大天数，即决定该缺口是否可以买入的最大跟踪日期。超过该日期后，系统不再跟踪该缺口。在确定交易集的时候，该参数是一个筛选因素，即在该参数覆盖的交易日期内形成的缺口，才会选入交易集。和MAX_TRADE_DAYS一样，该参数是以交易日历天数（非自然日历天数）来计算的。
- TEST_DATASET_PERCENT：测试数据集占训练数据集的比重。
- MIN_PRED_RATE：最低预期收益率，在确定buy_in_list.csv清单时，该参数是一个筛选因素。只用当trade_pred.csv文件中缺口预期收益率大于该参数时，才能入选buy_in_list.csv文件。
- PRED_RATE_PCT：预期收益率折扣百分比。决定缺口是否可以买入的先决条件:市场价和目标价的收益水平大于该缺口预期收益率和该参数的乘积。当一个缺口在honding_list.csv中持有天数（自然日历天数）大于10天以上时，年化收益率大于MIN_PRED_RATE*PRED_RATE_PCT*365/10，系统会选择卖出（即使该缺口未回补）。
- COST_FEE：交易税费合计，设定为万分之5，申万宏源证券的实际交易水平为万分之3.5。
- MAX_STOCKS：最大持股数，当持股数超过此参数值时，系统不再买入新的股票。
- ONE_TIME_FUNDS：单次买入投入的资金额度。
- MIN_STOCK_PRICE：买入股票的最低价格，低于此价格的股票，系统不会买入。
- SHUFFLE：决定训练时是否打乱数据集。
- PRED_MODELS：用于预测交易集预期收益率的模型数。
- initial_funds：初始投入资金，可以通过trade.change_trade_funds来调整资金额。
- additional_rate：当第一跌停缺口出现后，通过预期收益率推断会继续出现跌停或者大跌，从而可能出现第二个大缺口时，提高第一个缺口的收益率水平，阻止交易。
- PAUSE：采用TS模式获取实时价格的情况下，获取价格后的时间间隔。
- exception_list：排除列表，股票名称中含有列表中的文字，不会列入买入清单。
#### 连续缺口的买点确定，难点问题
##### 连续跌停形成的缺口，隐含了较大的风险，需要谨慎对待
- 在buy_in_list.csv中，当一个缺口当天的pct_chg为-10%（即跌停板），同时系统推算该缺口的pred大于21%，即意味着系统推算该股票还会再下跌一个10%。经验证，在实际运行中，通常是以再一个跌停板的形式来打开买入空间。同时第二个跌停板往往也会形成一个新的买入缺口。这时buy_in_list.csv中会同时存在同一个股票的2个（或者更多）买入缺口，该如何确定第一个缺口的买入价格呢？
- 如果缺口当日跌停，且预期收益率大于21%，可以合理推断明日会出现大跌或者再次跌停，系统会形成第二买入缺口。但是在第二个买入缺口形成之前，可能就已经触发了第一个缺口买入条件了。这时需要等-等，如果如期出现了第二个缺口，就转到多缺口情形确定买入价格。如果没有如期出现第二个缺口，就强制提高买入条件（程序中采用了加additional_rate的预期收益方式来提供额外的安全保证）。
- 如果存在多个缺口未买入，每个缺口买点确定的方式和单独缺口买点的确定方式不同。将全部缺口买点的最低值作为全部缺口的买点。一旦达到买点，则全部缺口一起买入。这样处理比较符合常识，从风险控制的角度来说，也是最稳妥的。
- 如果出现三个以上未买入的缺口，需要防止连续跌停。
- 参数设置问题：
  - MIN_PRED_RATE和PRED_RATE_PCT参数的取值直接影响投资风险和效果。MIN_PRED_RATE越低，进入buy_in_list.csv缺口数量就越多。MIN_PRED_RATE * PRED_RATE_PCT越低，就越容易成交（成交价格较高即可成交），成交笔数较多，但是投资风险较大；MIN_PRED_RATE * PRED_RATE_PCT越高，成交就越困难（成交价格较低才可成交），投资笔数较少，但是投资风险较小。还需要持续测试优化，在投资笔数 * 投资收益优化上取得较好的结果。
  - MAX_TRADE_DAYS即是缺口持仓的最大天数，不要高于30天（相当于自然日历42天左右，似乎有点长了）。
  - TRADE_COVERAGE_DAYS是系统跟踪一个缺口的天数，最好和MAX_TRADE_DAYS保持5-8天的差距。
#### 风险来源
##### DownGap 模型风险可能来自于方方面面
- 模型失效。模型在训练集和测试集上较好拟合，在交易集上拟合无效。
- 数据集风险。训练集、验证集、测试集和交易集采用了不同的选择标准，比如交易集使用了排除列表筛选，而训练集、测试集未使用排除列表筛选。
- 执行风险。即在模型发出买入卖出信号后，实际操作和模型存在差异。
- 股票实时价格获取速度。如果股票实时价格获取速度太慢，可能会丧失交易机会。
- 研究不够深入，未能发现缺口行为模式的变化。比如缺口回补的比例出现了显著的降低，但是未能及时反映在模型中，导致模型预测功能降低甚至失效。
- 代码错误。这种风险无处不在，防不胜防。如前次把time.sleep()写成了time.slee(),由于在线程池中运行，没有报错，导致卖出模块失效，原因难寻。比如yyyymmdd型日期格式的处理，在保存过程中会出现string向float的自主转换，这些小问题，如果关注不到，也会造成大麻烦。今后处理日期型字段，将采用yyyymmdd H:m:s格式。比如np.nan、None的区别，也会造成不少问题。
#### 风险控制
##### DownGap 模型采用以下风险控制措施
- 通过最大持股个数MAX_STOCKS来控制单个股票最大投资比例。该参数一般要超过50，从而控制单个股票最大持仓比例不超过2%。
- 通过单次买入资金ONE_TIME_FUNDS来控制单次买入的金额。
- 通过最大持股个数MAX_STOCKS 和 单次买入资金ONE_TIME_FUNDS来控制最大投资金额占可投资金额的比例。
- 通过exception_list强制排除风险股票:退市股票、st股票、pt股票、连续跌停股票等。
- 通过最低买入价格MIN_STOCK_PRICE来回避股价过低的股票。
- 通过calculate_gaps_buy_in_points函数，调整连续多缺口，特别是连续跌停多缺口的买点调整来控制连续跌停风险。
- 如果缺口预期收益率pred超过MIN_PRED_RATE 30%，则买入资金在ONE_TIME_FUNDS基础上提高15%，实现风控和收益的平衡。
#### 几个文件中的指标说明
##### 缺口数据集文件
- trade_date：缺口形成的基准日。
- fill_date：缺口回补的日期。
- days：今天和缺口基准日之间的间隔天数，以交易日历为基础计算。
- gap_percent：缺口比率，等于（缺口基准日最高价-基准日前一日最低价）/基准日前一日最低价。
- pct_chg：缺口基准日当日涨跌幅。
- vol_ratio：量比，即今日成交量/昨日成交量。 
- RSI和K指标：即是股票技术分析中的RSI指标和K指标。K指标默认天数为9天。
- turnover_rate：换手率。
- rise_percent：缺口回补过程中的实际涨幅，等于（缺口基准日前一日最低价-回补过程中的最低价）/回补过程中的最低价。缺口基准日前一日最低价即target_price。这个值就是数据集的标签值。
##### buy_in_list.csv
- trade_date：缺口形成的基准日。
- fill_date： 缺口回补日期，为空。
- days：今天和缺口基准日之间的间隔天数，以交易日历为基础计算。
- gap_percent：缺口比率，等于（缺口基准日最高价-基准日前一日最低价）/基准日前一日最低价。
- pct_chg：缺口基准日当日涨跌幅。
- pred：模型预测的缺口收益率，即rise_percent的预测值。
- real: 缺口实际收益率，为空。
- target_price：缺口买入后的上涨的目标价格，等于缺口基准日前一日最低价。
##### holding_list.csv
- days：今天和缺口基准日之间的间隔天数，以交易日历为基础计算。
- holding_days：持有天数，等于今天和买入日期之间的间隔天数，以自然日历为基础计算。
- target_price：缺口买入后的卖出的目标价格，等于缺口基准日前一日最低价。
- date_in和date_out：买入日期和卖出日期。
- price_in、price_out和price_now：买入价 卖出价和现价。
- amount：资金余额和股票数量。
- cost_fee：交易税费比例，设定值为万分之5。
- profit：利润额，等于(price_now*(1-cost_fee) - price_in*(1+cost_fee)) * amount
- rate_pred和rate_pct：即缺口买入时，系统设定的MIN_PRED_RATE和PRED_RATE_PCT值。
- rate_current：现在的收益率，等于profit / (price_in * amount)
- rate_yearly：年化收益率，等于rate_current * 365 / holding_days，以自然日历天数计算。
